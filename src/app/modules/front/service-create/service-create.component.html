<app-breadcrumb [titulo]="titulo" [subTitulo]="subTitulo" [urlBreadcrumb]="urlBreadcrumb"></app-breadcrumb>

<div class="container-fluid mt--7">
  <form (submit)="save()">
    <div class="row">
      <div class="col-xl-6">
          <div class="card bg-secondary shadow">
            <div class="card-header bg-white border-0">
              <div class="row align-items-center">
                <div class="col-8">
                  <h3 class="mb-0">Cadastro de serviços</h3>
                </div>
                <div class="col-4">
                  <button *ngIf="servico.id" class="btn btn-primary btn-sm float-right" type="button" (click)="edit()">Editar</button>
                </div>
              </div>
            </div>
            <div class="card-body">
                <div class="row">
                  <div class="col-lg-6">
                    <div class="form-group">
                      <label class="form-control-label" >Cliente</label>
                      <div class="form-control-label float-right" ><a [swal]="clienteSwal" class="mouse-link"><i class="fas fa-plus-circle"></i> Novo cliente</a></div>

                      <select [(ngModel)]="servico.pessoa.id" [disabled]="!formEdit" name="cliente" class="form-control form-control-alternative">
                        <option *ngFor="let cliente of clientes" value="{{cliente.id}}">{{ cliente.nome }}</option>
                      </select>

                    </div>
                  </div>

                  <div class="form-group col-md-6">
                    <div class="form-group">
                      <label class="form-control-label" >Responsável</label>
                      <select [(ngModel)]="servico.responsavel.id" [disabled]="!formEdit" name="usuario" class="form-control form-control-alternative">
                        <option value="0">Selecione</option>
                        <option *ngFor="let usuario of usuarios" value="{{usuario.id}}">{{ usuario.nome }}</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group col-md-12">
                    <div class="form-group">
                      <label class="form-control-label" >Equipamento</label>
                      <div class="form-control-label float-right mouse-link" ><i class="fas fa-plus-circle"></i> Novo equipamento</div>
                      <select [(ngModel)]="servico.equipamento.id" [disabled]="!formEdit" name="equipamento" class="form-control form-control-alternative">
                        <option value="0">Selecione</option>
                        <option *ngFor="let equipamento  of equipamentos" value="{{equipamento.id}}">{{ equipamento.nome }}</option>
                      </select>
                    </div>
                  </div>


                  <div class="col-lg-12">
                    <div class="form-group">
                      <label class="form-control-label" >Defeito relatado</label>
                      <textarea [(ngModel)]="servico.relato" name="relato" class="form-control">{{ servico.relato }}</textarea>
                    </div>
                  </div>

                  <div class="col-lg-12">
                    <div class="form-group">
                      <label class="form-control-label" >Acessórios</label>
                      <textarea [(ngModel)]="servico.acessorios" name="relato" class="form-control">{{ servico.acessorios }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xl-6">
            <div class="col-xl-12">
              <div class="card shadow table-produtos" >
                <div class="card-body">
                  <div class="row">
                    <div class="col-lg-10">
                      <div class="form-group">
                        <label class="form-control-label" >Produto/Serviço</label>
                        <ng-select class="ng-custom" (change)=setProduto($event)
                          [items]="products"
                          bindLabel="nome"
                          bindValue="produto"
                          loadingText="Carregando..."
                          notFoundText="Item não encontrado"
                          placeholder="Digite o Nome/código/EAN do produto"
                          labelForId="buscaProduto"
                          [searchFn]="buscaProduto"
                        ></ng-select>
                      </div>
                    </div>

                    <div class="col-lg-2">
                      <div class="form-group">
                        <label class="form-control-label" >Qtde</label>
                        <input type="text" [(ngModel)]="qt" #qtProduto (keyup.enter)=addProduto() name="qt" class="form-control" placeholder="QT">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-12 mt-4">
              <div class="card shadow table-produtos" [style.height.px]="240">
                <div class="table-responsive">
                  <table class="table table-hover align-items-center table-flush ">
                    <thead class="thead-light">
                    <tr>
                      <th scope="col">Nome do produto</th>
                      <th scope="col">Qtde</th>
                      <th scope="col">Preço Unit</th>
                      <th scope="col">&nbsp;</th>
                    </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of servico.itensServico" >
                        <td class="prod-name" title="{{item.produto.nome}}">{{item.produto.nome.substring(0, 20)}}</td>
                        <td class="text-right">{{item.qt}}</td>
                        <td class="text-right">{{ (+item.produto.preco).toFixed(2)}}</td>

                        <td><a (click)=removeItem(item) class="mouse-link"><i class="fas fa-trash text-danger"></i></a></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-xl-12 mt-4">
              <div class="card shadow table-produtos" >
                <div class="card-body">
                  <div class="row">
                    <div class="col-lg-4">
                      <div class="form-group">
                        <label class="form-control-label">Desconto</label>
                        <input type="text" [(ngModel)]="servico.desconto" [disabled]="!formEdit" name="desconto" class="form-control form-control-alternative"  value="{{servico.desconto.toFixed(2)}}" currencyMask [options]="{ prefix: 'R$ ', thousands: '.', decimal: ',' }">
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <div class="form-group">
                        <label class="form-control-label">Valor entrada</label>
                        <input type="text" [(ngModel)]="valorEntrada" [disabled]="!formEdit" name="entrada" class="form-control form-control-alternative"  value="{{valorEntrada.toFixed(2)}}" currencyMask [options]="{ prefix: 'R$ ', thousands: '.', decimal: ',' }">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-12 mt-4">
              <div class="row">
                <div class="col col-lg-2 pl-lg-12 text-right" >
                  <label class="form-control-label text-prod" >Subtotal</label>
                  <h1>{{subtotal.toFixed(2)}}</h1>
                </div>
                <div class="col col-lg-2 pl-lg-12 text-right" >
                  <label class="form-control-label text-prod" >Desconto</label>
                  <h1>{{servico.desconto.toFixed(2)}}</h1>
                </div>
                <div class="col col-lg-2 pl-lg-12 text-right" >
                    <label class="form-control-label text-prod" >Total</label>
                    <h1>{{servico.total.toFixed(2)}}</h1>
                </div>

                <div class="col col-lg-6 pl-lg-12 d-flex flex-row-reverse pt-4" >
                  <button #btnFinalizar [disabled]="servico.total == 0" (click)=finalizar() class="btn btn-info mr-2 mb-2" > <i class="fas fa-save"></i> Salvar (F9)</button>
                </div>
              </div>
            </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Modal cliente ------------------------------------------------------->
  <swal #clienteSwal title="Novo Cliente" [showConfirmButton]=false >
    <div *swalPortal >
      <div class="row">
        <div class="col-lg-6">
          <div class="form-group text-left">
            <label class="form-control-label" >Nome/Nome fantasia</label>
            <input type="text" [(ngModel)]="servico.pessoa.nome" [disabled]="!formEdit" required="required" name="nome" class="form-control form-control-alternative" placeholder="Nome" value="{{servico.pessoa.nome}}">
          </div>
        </div>
        <div class="col-lg-6">
          <div class="form-group text-left">
            <label class="form-control-label">Celular</label>
            <input type="tel" [(ngModel)]="servico.pessoa.celular" [disabled]="!formEdit" name="celular" class="form-control form-control-alternative"  mask="(00) 00000-0000" placeholder="Número do celular" value="{{servico.pessoa.celular | mask: '(00) 00000-0000'}}">
          </div>
        </div>

      </div>
      <div class="row">
        <div class="col-lg-12 text-right">
          <button class="btn btn-info" #btnFinalizar (click)=addCliente() >Salvar</button>
        </div>
      </div>
    </div>
  </swal>

<!-- Modal equipamento --------------------------------------------->
<swal #clienteSwal title="Novo Cliente" [showConfirmButton]=false >
  <div *swalPortal >
    <div class="row">
      <div class="col-lg-6">
        <div class="form-group text-left">
          <label class="form-control-label" >Nome</label>
          <input type="text" [(ngModel)]="servico.pessoa.nome" [disabled]="!formEdit" required="required" name="nome" class="form-control form-control-alternative" placeholder="Nome" value="{{servico.pessoa.nome}}">
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-group text-left">
          <label class="form-control-label">Celular</label>
          <input type="tel" [(ngModel)]="servico.pessoa.celular" [disabled]="!formEdit" name="celular" class="form-control form-control-alternative"  mask="(00) 00000-0000" placeholder="Número do celular" value="{{servico.pessoa.celular | mask: '(00) 00000-0000'}}">
        </div>
      </div>

    </div>
    <div class="row">
      <div class="col-lg-12 text-right">
        <button class="btn btn-info" #btnFinalizar (click)=addCliente() >Salvar</button>
      </div>
    </div>
  </div>
</swal>

